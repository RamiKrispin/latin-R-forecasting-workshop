---
title: "Modeling Seasonality"
author: "Rami Krispin"
date: last-modified
format: 
    html:
        code-fold: false
        warning: false
        toc: true
---


```{r}
#| label: setup
library(feasts)
library(fabletools)
library(tsibble)
library(dplyr)
library(plotly)

source("./functions.R")
```

Next, let's load the datasets:
```{r}
#| label: load the data

load(file = "./data/ts.RData")
```



```{r}
p <- plot_ly() |>
    add_lines(x = ts2$index, y = ts2$y, type = "scatter", mode = "lines", name = "Actual") |>
    plotly::layout(
        title = "US Monthly Demand for Natural Gas",
        yaxis = list(title = "MMCF"),
        xaxis = list(title = "Month")
    )

p
```

Let's decompose the series:

```{r}
stl_d <- ts2 |>
    model(STL(y)) |>
    components()

plot_decomposition(stl_d, var = "y", outliers = TRUE)
```



Likewise, let's review the ACF plot:

```{r}
plot_acf(ts = ts2, var = "y", lag_max = 72, frequency = 12, alpha = 0.05)
```

## Add Trend Feature

We will build the features step-by-step to review the impact of each feature on the goodness of fit. Let's start by defining the trend feature:

```{r}
ts2$trend <- 1:nrow(ts2)

ts2
```

```{r}
md1 <- lm(y ~ trend, data = ts2)

summary(md1)
```


We will fit the model on the series to see the trend fit:

```{r}
fit1 <- predict(object = md1, newdata = ts2, interval = "confidence", level = 0.95)
ts2$fit1 <- fit1[, 1]
p1 <- p |>
    add_lines(x = ts2$index, y = ts2$fit1, mode = "lines", line = list(color = "black", dash = "dash"), name = "Fitted")

p1
```

Let's plot the model residuals:
```{r}
#| fig-width: 15
#| fig-height: 18
plot_residuals(
    data = ts2,
    index_col = "date",
    actual_col = "y",
    fitted_col = "fit1",
    lag_max = 60,
    alpha = 0.05,
    frequency = 12
)
```




::: {.callout-tip}
## Detranding the Series

If you check the model residuals, you will noticed that the residuals are detrained version of the original series.
:::

## Add Seasonal Feature
We will now add the seasonal feature by creating a categorical variable for each month of the year:

```{r}
ts2$month <- lubridate::month(ts2$index, label = TRUE)
ts2
```


```{r}
md2 <- lm(y ~ trend + month, data = ts2)

summary(md2)
```

As you can noticed from the model summary, adding the seasonal feature improved the model goodness of fit. Let's fit the model and evaluate the model's residuals:

```{r}
fit2 <- predict(object = md2, newdata = ts2, interval = "confidence", level = 0.95)
ts2$fit2 <- fit2[, 1]
```

Let's plot the residuals:

```{r}
#| fig-width: 15
#| fig-height: 18
plot_residuals(
    data = ts2,
    index_col = "date",
    actual_col = "y",
    fitted_col = "fit2",
    lag_max = 60,
    alpha = 0.05,
    frequency = 12
)
```

Let's now create a 5 year (or 60 months) forecast by setting the future data frame:

```{r}
h <- 5 * 12
```

As before, we will use the `new_data` function from the **tsibble** library to create a continues data frame with the series future index:

```{r}
future_data <- new_data(ts2, n = h)
future_data |> head()
```

Next, let's start to add the feature we created so far - trend and seasonal features:

```{r}
# Adding the trend feature:
tail(ts2)
trend_start <- max(ts2$trend) + 1
future_data$trend <- trend_start:(trend_start + h - 1)

# Adding the seasonal feature:
future_data$month <- lubridate::month(future_data$index, label = TRUE)
future_data |> head()
```

::: {.callout-caution collapse="false"}
When creating categorical variables in a future data frame, you should ensure that the categorical variables contain the exact same levels as the ones used in the training dataset.
:::

Let's now create the forecast with the `predict` function:


Let's create the forecast and plot it:
```{r}
fc2 <- lm_forecast(
    model = md2,
    actual = ts2,
    future_data = future_data,
    actual_col = "y",
    lag_col = NULL,
    level = 0.95
)
```

```{r}
plot_lm_forecast(fc2, actual_col = "y")
```




The is a ton of information that left on the residuals!

We will explore the following features:

- Structural breaks
- Piecewise Linear Trend
- AR
- Outliers


## Structural Break Feature

Often, time series would have an abrupt shift in its structure due to some event. A good example, is the Covid-19 pandemic impact on some macro-economic indicators such as the unemployment rate and number of passengers traveling on airplanes. At the end of this change, the series would be in a new level. 

We can notice that the natural gas series had a structural break on the trend component around September 2018. To model a structural break, we will create a new variable that is equal to 0 prior to September 2018 and 1 after this date:

```{r}
ts2$structural_break <- ifelse(ts2$date >= as.Date("2018-09-01"), 1, 0)

ts2 |> head()

ts2 |> tail()
```

Let's update the regression model with the structural break feature:



```{r}
md3 <- lm(y ~ trend + month + structural_break, data = ts2)

summary(md3)
```

As you can  noticed from the model summary, adding the seasonal feature improved the model goodness of fit.


```{r}
fit3 <- predict(object = md3, newdata = ts2, interval = "confidence", level = 0.95)
ts2$fit3 <- fit3[, 1]
p3 <- p |>
    add_lines(x = ts2$index, y = ts2$fit3, mode = "lines", line = list(color = "black", dash = "dash"), name = "Fitted")

p3
```

Let's plot the model residuals:
```{r}
#| fig-width: 15
#| fig-height: 18
plot_residuals(
    data = ts2,
    index_col = "date",
    actual_col = "y",
    fitted_col = "fit3",
    lag_max = 60,
    alpha = 0.05,
    frequency = 12
)
```

Let's re-forecast the series:

```{r}
future_data$structural_break <- 1

fc3 <- lm_forecast(
    model = md3,
    actual = ts2,
    future_data = future_data,
    actual_col = "y",
    lag_col = NULL,
    level = 0.95
)
```

```{r}
plot_lm_forecast(fc3, actual_col = "y")
```





## Handling Outliers

We can notices that the series has some years where the consumption is higher than normal years. We can segment two groups of outliers:

- High: Jan 2025
- Medium: Jan 2014, Jan 2018, Jan 2019, Jan 2022, Jan 2024

Let's create the features:

```{r}
ts2$outlier_high <- ifelse(ts2$date == as.Date("2025-01-01"), 1, 0)
outlier_medium_dates <- c(as.Date("2014-01-01"), as.Date("2018-01-01"), as.Date("2019-01-01"), as.Date("2022-01-01"), as.Date("2024-01-01"))
ts2$outlier_medium <- ifelse(ts2$date %in% outlier_medium_dates, 1, 0)

table(ts2$outlier_high)
table(ts2$outlier_medium)
```

Let's update the future data frame:

```{r}
future_data$outlier_medium <- 0
future_data$outlier_high <- 0
```

Let's train the model with the new features:

```{r}
md4 <- lm(y ~ trend + month + structural_break + outlier_high + outlier_medium, data = ts2)

summary(md4)
```

Let's refit the model and plot the residuals:

```{r}
fit4 <- predict(object = md4, newdata = ts2, interval = "confidence", level = 0.95)

ts2$fit4 <- fit4[, 1]
```


Let's plot the model residuals:
```{r}
#| fig-width: 15
#| fig-height: 18
plot_residuals(
    data = ts2,
    index_col = "date",
    actual_col = "y",
    fitted_col = "fit4",
    lag_max = 60,
    alpha = 0.05,
    frequency = 12
)
```




